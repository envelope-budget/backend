#!/bin/bash

# Ensure we're on main and up to date
git checkout main
git pull origin main
git status | grep -q "nothing to commit, working tree clean" || {
  echo "❌ Error: Working tree not clean"
  exit 1
}

# Create a new branch for updates
BRANCH_NAME="dependency-updates-$(date +%Y%m%d)"
if git show-ref --verify --quiet refs/heads/$BRANCH_NAME; then
  echo "⚠️ Branch $BRANCH_NAME already exists. Using a unique name."
  BRANCH_NAME="dependency-updates-$(date +%Y%m%d-%H%M%S)"
fi
git checkout -b $BRANCH_NAME

# Update npm packages
if [ -f package.json ]; then
  echo "📦 Updating npm packages..."
  npx npm-check-updates -u
  pnpm install
fi

# Update Python packages
if [ -f requirements.txt ]; then
  echo "🐍 Updating Python packages..."
  pip install pip-tools
  # Create a temporary requirements file with updated versions
  pip-compile --upgrade --output-file requirements.txt.new requirements.txt
  mv requirements.txt.new requirements.txt
  pip install -r requirements.txt
fi

# Commit all changes
git add .
git commit -m "chore: update dependencies"

echo "✅ Updates complete. New branch '$BRANCH_NAME' created with dependency updates."
echo "👀 Please review and merge the changes."
