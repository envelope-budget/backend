#!/bin/bash

# Ensure we're on main and up to date
git checkout main
git pull origin main
git status | grep -q "nothing to commit, working tree clean" || {
  echo "❌ Error: Working tree not clean"
  exit 1
}

# Create a new branch for updates
BRANCH_NAME="dependency-updates-$(date +%Y%m%d)"
git checkout -b $BRANCH_NAME

# Update npm packages
if [ -f package.json ]; then
  echo "📦 Updating npm packages..."
  npx npm-check-updates -u
  pnpm install
  git add package.json pnpm-lock.yaml
  git commit -m "chore: update npm dependencies"
fi

# Update Python packages
if [ -f requirements.txt ]; then
  echo "🐍 Updating Python packages..."
  pip install pip-tools
  # Create a new requirements.txt with updated versions
  pip-compile --upgrade requirements.txt
  pip install -r requirements.txt
  git add requirements.txt
  git commit -m "chore: update Python dependencies"
fi

echo "✅ Updates complete. New branch '$BRANCH_NAME' created with dependency updates."
echo "👀 Please review and merge the changes."
